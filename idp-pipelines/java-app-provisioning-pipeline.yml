# idp-pipelines/java-app-provisioning-pipeline.yml
pipeline:
  name: Cookiecutter Java App Provisioning
  identifier: Cookiecutter_Java_App_Provisioning
  projectIdentifier: parson
  orgIdentifier: sandbox
  tags: {}

  stages:
    - stage:
        name: App Provisioner
        identifier: App_Provisioner
        type: IDP
        spec:
          infrastructure:
            type: KubernetesDirect
            spec:
              connectorRef: parsoneks
              namespace: harness-delegate-ng
              automountServiceAccountToken: true
              nodeSelector: {}
              os: Linux

          execution:
            steps:
              # ----------------------------
              # Derive & normalize variables
              # ----------------------------
              - step:
                  type: Run
                  name: Derive Vars
                  identifier: Derive_Vars
                  spec:
                    registryRef: parson
                    image: parsontodd/harness-custom-runner:latest
                    shell: Bash
                    command: |-
                      set -euo pipefail

                      # Auth for gh/curl
                      GH_TOKEN="<+pipeline.variables.gh_token>"
                      GITHUB_TOKEN="<+pipeline.variables.gh_token>"

                      : "${GH_ORG:?GH_ORG is required}"
                      : "${BASE_REPO:?BASE_REPO is required}"
                      : "${PROJECT_SLUG:?PROJECT_SLUG is required}"

                      DEFAULT_BRANCH="${DEFAULT_BRANCH:-main}"
                      NEW_BRANCH_PREFIX="${NEW_BRANCH_PREFIX:-feature}"
                      REQUESTOR_GH_USERNAME="${REQUESTOR_GH_USERNAME:-}"
                      TESTING="${TESTING:-no}"
                      GIT_AUTHOR_NAME="${GIT_AUTHOR_NAME:-Harness IDP Bot}"
                      GIT_AUTHOR_EMAIL="${GIT_AUTHOR_EMAIL:-idp-bot@users.noreply.github.com}"

                      # Workspace paths
                      WORKSPACE="${HARNESS_WORKSPACE:-/harness}"
                      REPO_DIR="${WORKSPACE}/${BASE_REPO}"

                      # Feature branch
                      SEQ="<+pipeline.sequenceId>"
                      FEATURE_BRANCH="${FEATURE_BRANCH:-${NEW_BRANCH_PREFIX}/${PROJECT_SLUG}-${SEQ}}"

                      BASE_URL="https://github.com/${GH_ORG}/${BASE_REPO}"
                      BRANCH_URL="${BASE_URL}/tree/${FEATURE_BRANCH}"

                      export GH_TOKEN GITHUB_TOKEN
                      export GH_ORG BASE_REPO DEFAULT_BRANCH NEW_BRANCH_PREFIX
                      export PROJECT_SLUG REQUESTOR_GH_USERNAME TESTING
                      export GIT_AUTHOR_NAME GIT_AUTHOR_EMAIL
                      export WORKSPACE REPO_DIR FEATURE_BRANCH BASE_URL BRANCH_URL

                      echo "Derived variables ready."
                    envVariables:
                      GH_ORG: <+pipeline.variables.gh_org>
                      BASE_REPO: <+pipeline.variables.base_repo>
                      DEFAULT_BRANCH: <+pipeline.variables.default_branch>
                      NEW_BRANCH_PREFIX: <+pipeline.variables.new_branch_prefix>
                      PROJECT_SLUG: <+pipeline.variables.project_slug>
                      REQUESTOR_GH_USERNAME: <+pipeline.variables.github_username>
                      TESTING: <+pipeline.variables.testing>
                      GIT_AUTHOR_NAME: Harness IDP Bot
                      GIT_AUTHOR_EMAIL: idp-bot@users.noreply.github.com
                    outputVariables:
                      - name: GH_ORG
                      - name: BASE_REPO
                      - name: DEFAULT_BRANCH
                      - name: NEW_BRANCH_PREFIX
                      - name: PROJECT_SLUG
                      - name: REQUESTOR_GH_USERNAME
                      - name: TESTING
                      - name: GIT_AUTHOR_NAME
                      - name: GIT_AUTHOR_EMAIL
                      - name: WORKSPACE
                      - name: REPO_DIR
                      - name: FEATURE_BRANCH
                      - name: BASE_URL
                      - name: BRANCH_URL

              # ----------------------------
              # Optional permissions gate
              # ----------------------------
              - step:
                  type: Run
                  name: Verify Requester Access
                  identifier: Verify_Requester_Access
                  spec:
                    registryRef: parson
                    image: parsontodd/harness-custom-runner:latest
                    shell: Bash
                    command: |-
                      set -euo pipefail
                      export GH_TOKEN="<+pipeline.variables.gh_token>"
                      export GITHUB_TOKEN="<+pipeline.variables.gh_token>"

                      OWNER="${GH_ORG}"
                      REPO="${BASE_REPO}"
                      USERNAME="${REQUESTOR_GH_USERNAME}"
                      ENFORCE="<+pipeline.variables.enforce_requestor_access>"
                      API="https://api.github.com"

                      if [[ -z "${USERNAME}" || "${USERNAME}" == "null" ]]; then
                        echo "No github_username provided. Skipping strict permission check."
                        PERMISSION="unknown"
                        CAN_COMMIT="false"
                        CAN_CREATE_PR="false"
                        export PERMISSION CAN_COMMIT CAN_CREATE_PR
                        [[ "${ENFORCE}" == "yes" ]] && exit 21 || exit 0
                      fi

                      # Repo fork policy
                      REPO_JSON="$(curl -fsS -H "Authorization: token $GITHUB_TOKEN" "$API/repos/$OWNER/$REPO")"
                      ALLOW_FORKING="$(echo "$REPO_JSON" | jq -r '.allow_forking // false')"

                      # Effective permission
                      PERM_JSON="$(curl -s -H "Authorization: token $GITHUB_TOKEN" "$API/repos/$OWNER/$REPO/collaborators/$USERNAME/permission")"
                      if [[ -z "$PERM_JSON" || "$(echo "$PERM_JSON" | jq -r '.message // empty')" == "Not Found" ]]; then
                        PERMISSION="none"
                      else
                        PERMISSION="$(echo "$PERM_JSON" | jq -r '.permission // "none"')"
                      fi

                      CAN_COMMIT="false"; CAN_CREATE_PR="false"
                      case "$PERMISSION" in
                        admin|maintain|write) CAN_COMMIT="true"; CAN_CREATE_PR="true" ;;
                        *) CAN_COMMIT="false"; [[ "$ALLOW_FORKING" == "true" ]] && CAN_CREATE_PR="true" ;;
                      esac

                      echo "permission=$PERMISSION allow_forking=$ALLOW_FORKING can_commit=$CAN_COMMIT can_pr=$CAN_CREATE_PR"

                      export PERMISSION CAN_COMMIT CAN_CREATE_PR
                      if [[ "$ENFORCE" == "yes" && "$CAN_COMMIT" != "true" ]]; then
                        echo "Requester lacks write permission."
                        exit 20
                      fi
                      echo "Access gate passed."
                    envVariables:
                      GH_ORG: <+pipeline.stages.App_Provisioner.spec.execution.steps.Derive_Vars.output.outputVariables.GH_ORG>
                      BASE_REPO: <+pipeline.stages.App_Provisioner.spec.execution.steps.Derive_Vars.output.outputVariables.BASE_REPO>
                      REQUESTOR_GH_USERNAME: <+pipeline.stages.App_Provisioner.spec.execution.steps.Derive_Vars.output.outputVariables.REQUESTOR_GH_USERNAME>
                    outputVariables:
                      - name: CAN_COMMIT
                      - name: CAN_CREATE_PR
                      - name: PERMISSION

              # ----------------------------
              # Clone target repo (standalone)
              # ----------------------------
              - step:
                  type: GitClone
                  name: Clone Repo
                  identifier: Clone_Repo
                  spec:
                    connectorRef: parsonghharnessidpsandbox
                    repoName: <+pipeline.variables.base_repo>
                    cloneDirectory: /harness/<+pipeline.variables.base_repo>
                    build:
                      type: branch
                      spec:
                        branch: <+pipeline.variables.default_branch>

              # ----------------------------
              # Create feature branch
              # ----------------------------
              - step:
                  type: Run
                  name: Create Branch
                  identifier: Create_Branch
                  spec:
                    registryRef: parson
                    image: parsontodd/harness-custom-runner:latest
                    shell: Bash
                    command: |-
                      #!/usr/bin/env bash
                      set -euo pipefail

                      export GH_TOKEN="<+pipeline.variables.gh_token>"
                      export GITHUB_TOKEN="<+pipeline.variables.gh_token>"

                      WORKSPACE="${HARNESS_WORKSPACE:-/harness}"
                      REPO_DIR="$WORKSPACE/$BASE_REPO"

                      command -v sudo >/dev/null 2>&1 && sudo chown -R "$(id -u)":"$(id -g)" "$REPO_DIR" || true
                      git config --global --add safe.directory "$REPO_DIR" || true

                      cd "$REPO_DIR"
                      git fetch --no-tags origin "$DEFAULT_BRANCH" --depth 1 || true
                      git switch -C "$DEFAULT_BRANCH" "origin/$DEFAULT_BRANCH" >/dev/null 2>&1 || git switch "$DEFAULT_BRANCH"
                      git switch -c "$FEATURE_BRANCH"

                      # ensure origin can push (convert to https+token if needed)
                      ORIGIN_URL="$(git remote get-url origin)"
                      case "$ORIGIN_URL" in
                        https://*@*) : ;;
                        https://*) git remote set-url origin "$(echo "$ORIGIN_URL" | sed -E 's#https://#https://oauth2:'"$GH_TOKEN"'@#')" ;;
                        git@*) SSH_PATH="$(echo "$ORIGIN_URL" | sed -E 's#^git@[^:]+:(.+)\.git#\1#')"
                               git remote set-url origin "https://oauth2:${GH_TOKEN}@github.com/${SSH_PATH}.git" ;;
                      esac

                      if [[ "${TESTING}" == "yes" ]]; then
                        echo "# IDP Testing Branch" > IDP_TESTING_README.md
                        git -c user.name="${GIT_AUTHOR_NAME}" -c user.email="${GIT_AUTHOR_EMAIL}" add IDP_TESTING_README.md
                        git -c user.name="${GIT_AUTHOR_NAME}" -c user.email="${GIT_AUTHOR_EMAIL}" commit -m "chore(idp:test): seed testing branch [skip ci]"
                      fi

                      git push -u origin "$FEATURE_BRANCH"

                      CLEAN_REMOTE="$(git remote get-url origin | sed 's#https://[^@]*@#https://#')"
                      export BASE_URL="$CLEAN_REMOTE"
                      export BRANCH_URL="${CLEAN_REMOTE%.git}/tree/${FEATURE_BRANCH}"
                      export REPO_NAME="$BASE_REPO"
                      export BRANCH_NAME="$FEATURE_BRANCH"
                      export REPO_DIR="$REPO_DIR"

                      echo "âœ… Branch created: ${CLEAN_REMOTE%.git}/tree/${FEATURE_BRANCH}"
                    envVariables:
                      BASE_REPO: <+pipeline.stages.App_Provisioner.spec.execution.steps.Derive_Vars.output.outputVariables.BASE_REPO>
                      DEFAULT_BRANCH: <+pipeline.stages.App_Provisioner.spec.execution.steps.Derive_Vars.output.outputVariables.DEFAULT_BRANCH>
                      FEATURE_BRANCH: <+pipeline.stages.App_Provisioner.spec.execution.steps.Derive_Vars.output.outputVariables.FEATURE_BRANCH>
                      TESTING: <+pipeline.stages.App_Provisioner.spec.execution.steps.Derive_Vars.output.outputVariables.TESTING>
                      GIT_AUTHOR_NAME: <+pipeline.stages.App_Provisioner.spec.execution.steps.Derive_Vars.output.outputVariables.GIT_AUTHOR_NAME>
                      GIT_AUTHOR_EMAIL: <+pipeline.stages.App_Provisioner.spec.execution.steps.Derive_Vars.output.outputVariables.GIT_AUTHOR_EMAIL>
                    outputVariables:
                      - name: BRANCH_URL
                      - name: BASE_URL
                      - name: REPO_NAME
                      - name: BRANCH_NAME
                      - name: REPO_DIR

              # ----------------------------
              # Cookiecutter scaffold (Java)
              # ----------------------------
              - step:
                  type: CookieCutter
                  name: Scaffold Repo
                  identifier: Scaffold_Repo
                  spec:
                    templateType: public
                    # TODO: set to Morningstar Java Spring Boot template repo
                    publicTemplateUrl: https://github.com/ORG/harness-admin-repo.git
                    outputDirectory: 
                    cookieCutterVariables:
                      # From "Application Details"
                      project_name:        <+pipeline.variables.project_name>
                      project_description: <+pipeline.variables.project_description>
                      author_name:         <+pipeline.variables.author_name>
                      group_id:            <+pipeline.variables.group_id>
                      version:             <+pipeline.variables.version>

                      # From "Derived & Naming"
                      project_slug:        <+pipeline.variables.project_slug>
                      package_name:        <+pipeline.variables.package_name>
                      artifact_id:         <+pipeline.variables.artifact_id>
                      package_path:        <+pipeline.variables.package_path>

                      # From "Container & Runtime"
                      docker_registry:     <+pipeline.variables.docker_registry>
                      docker_image_name:   <+pipeline.variables.docker_image_name>
                      k8s_namespace:       <+pipeline.variables.k8s_namespace>

                      # Repo context (if your template needs it)
                      github_org:          <+pipeline.variables.gh_org>
                      github_repo:         <+pipeline.variables.base_repo>
                    verbose: false
                    overwriteIfExists: false

              # ----------------------------
              # Push scaffold to feature branch
              # ----------------------------
              - step:
                  type: DirectPush
                  name: Push to Branch
                  identifier: DirectPush_1
                  spec:
                    connectorType: Github
                    connectorRef: parsonghharnessidpsandbox
                    organization: <+pipeline.variables.gh_org>
                    repository: <+pipeline.variables.base_repo>
                    codeDirectory: /harness/<+pipeline.variables.base_repo>
                    branch: <+pipeline.variables.new_branch_prefix>/<+pipeline.variables.project_slug>-<+pipeline.sequenceId>
                  when:
                    stageStatus: Success
                    condition: <+pipeline.variables.testing> == "no"

              # ----------------------------
              # Open PR
              # ----------------------------
              - step:
                  type: Run
                  name: Open Pull Request
                  identifier: Open_PR
                  spec:
                    registryRef: parson
                    image: parsontodd/harness-custom-runner:latest
                    shell: Bash
                    command: |-
                      #!/usr/bin/env bash
                      set -euo pipefail

                      export GH_TOKEN="<+pipeline.variables.gh_token>"
                      export GITHUB_TOKEN="<+pipeline.variables.gh_token>"

                      OWNER="${GH_ORG}"
                      REPO="${BASE_REPO}"
                      BASE="${DEFAULT_BRANCH}"
                      HEAD="${FEATURE_BRANCH}"

                      WORKSPACE="${HARNESS_WORKSPACE:-/harness}"
                      REPO_DIR="${REPO_DIR:-$WORKSPACE/$BASE_REPO}"

                      echo "Repo: $OWNER/$REPO  Base: $BASE  Head: $HEAD"

                      gh --version >/dev/null || { echo "gh missing"; exit 1; }
                      jq --version >/dev/null || { echo "jq missing"; exit 1; }
                      curl --version >/dev/null || { echo "curl missing"; exit 1; }

                      curl -fsS -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/$OWNER/$REPO" >/dev/null
                      curl -fsS -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/$OWNER/$REPO/branches/$BASE"  >/dev/null
                      curl -fsS -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/$OWNER/$REPO/branches/$HEAD"  >/dev/null

                      TITLE="feat(idp:<+pipeline.sequenceId>): scaffold ${PROJECT_SLUG}"

                      ensure_label() {
                        local name="$1" color="$2" desc="$3"
                        if ! gh api "repos/$OWNER/$REPO/labels/$name" >/dev/null 2>&1; then
                          gh api -X POST "repos/$OWNER/$REPO/labels" \
                            -f name="$name" -f color="$color" -f description="$desc" >/dev/null || true
                        fi
                      }

                      ensure_label "idp"        "BFD4F2" "Created by Harness IDP"
                      ensure_label "scaffold"   "1D76DB" "Scaffolded code"
                      ensure_label "automation" "5319E7" "Automated change"
                      [[ "${TESTING}" == "yes" ]] && ensure_label "testing" "0E8A16" "Testing run"

                      # PR body with context
                      META_BLOCK=$'\n\n## ðŸ§© IDP Context\n'\
                      "**Requester:** ${REQUESTOR_GH_USERNAME:-automation}"$'\n'\
                      "**Pipeline:** <+pipeline.identifier> | **Run #:** <+pipeline.sequenceId>"$'\n'\
                      "**Execution URL:** <+pipeline.executionUrl>"$'\n'\
                      "**Feature Branch:** \`$HEAD\` --> **Target Branch:** \`$BASE\`."

                      COMBINED="/tmp/combined_body.md"
                      printf "%s" "$META_BLOCK" > "$COMBINED"

                      LABELS=(--label idp --label scaffold --label automation)
                      [[ "${TESTING}" == "yes" ]] && LABELS+=(--label testing)

                      EXIST_JSON="$(gh pr list --repo "$OWNER/$REPO" --head "$OWNER:$HEAD" --state open --json number,url 2>/dev/null || echo '[]')"
                      COUNT="$(echo "$EXIST_JSON" | jq 'length')"

                      if [[ "$COUNT" -gt 0 ]]; then
                        PR_NUMBER="$(echo "$EXIST_JSON" | jq -r '.[0].number')"
                        PR_URL="https://github.com/$OWNER/$REPO/pull/$PR_NUMBER"
                        echo "PR already exists: $PR_URL"
                      else
                        gh pr create --repo "$OWNER/$REPO" \
                          --base "$BASE" --head "$HEAD" \
                          --title "$TITLE" --body-file "$COMBINED" \
                          "${LABELS[@]}"
                        PR_NUMBER="$(gh pr view --repo "$OWNER/$REPO" "$HEAD" --json number --jq .number)"
                        PR_URL="https://github.com/$OWNER/$REPO/pull/$PR_NUMBER"
                        echo "âœ… Opened PR: $PR_URL"
                      fi

                      export PR_URL PR_NUMBER
                    envVariables:
                      GH_ORG: <+pipeline.stages.App_Provisioner.spec.execution.steps.Derive_Vars.output.outputVariables.GH_ORG>
                      BASE_REPO: <+pipeline.stages.App_Provisioner.spec.execution.steps.Derive_Vars.output.outputVariables.BASE_REPO>
                      DEFAULT_BRANCH: <+pipeline.stages.App_Provisioner.spec.execution.steps.Derive_Vars.output.outputVariables.DEFAULT_BRANCH>
                      FEATURE_BRANCH: <+pipeline.stages.App_Provisioner.spec.execution.steps.Derive_Vars.output.outputVariables.FEATURE_BRANCH>
                      PROJECT_SLUG: <+pipeline.stages.App_Provisioner.spec.execution.steps.Derive_Vars.output.outputVariables.PROJECT_SLUG>
                      REQUESTOR_GH_USERNAME: <+pipeline.stages.App_Provisioner.spec.execution.steps.Derive_Vars.output.outputVariables.REQUESTOR_GH_USERNAME>
                      TESTING: <+pipeline.stages.App_Provisioner.spec.execution.steps.Derive_Vars.output.outputVariables.TESTING>
                      GIT_AUTHOR_NAME: <+pipeline.stages.App_Provisioner.spec.execution.steps.Derive_Vars.output.outputVariables.GIT_AUTHOR_NAME>
                      GIT_AUTHOR_EMAIL: <+pipeline.stages.App_Provisioner.spec.execution.steps.Derive_Vars.output.outputVariables.GIT_AUTHOR_EMAIL>
                    outputVariables:
                      - name: PR_URL
                      - name: PR_NUMBER

          cloneCodebase: false
          caching:
            enabled: false
            paths: []
          buildIntelligence:
            enabled: false

  variables:
    # -------- Form: Application Details --------
    - name: project_name
      type: String
      value: <+input>
    - name: project_description
      type: String
      value: <+input>.default(A sample Java application built with Spring Boot)
    - name: author_name
      type: String
      value: <+input>.default(Harness)
    - name: group_id
      type: String
      value: <+input>.default(com.harness)
    - name: version
      type: String
      value: <+input>.default(1.0-SNAPSHOT)
    # -------- Form: Derived & Naming --------
    - name: project_slug
      type: String
      value: <+input>.default(<+pipeline.variables.project_name.toLowerCase().replace(" ", "-")>)
    - name: package_name
      type: String
      value: <+input>.default(<+pipeline.variables.project_name.toLowerCase().replace(" ", "")>)
    - name: artifact_id
      type: String
      value: <+input>.default(<+pipeline.variables.project_slug>)
    - name: package_path
      type: String
      value: <+input>.default(<+pipeline.variables.group_id.replace(".", "/") + "/" + pipeline.variables.package_name>)
    # -------- Options / Controls (not on form, safe defaults) --------
    - name: testing
      type: String
      value: <+input>.default(no).selectOneFrom(yes,no)
    - name: enforce_requestor_access
      type: String
      value: <+input>.default(yes).selectOneFrom(yes,no)
    - name: enable_jira
      type: String
      value: false
    - name: register_component
      type: String
      value: false
    # -------- Secrets --------
    - name: gh_token
      type: Secret
      value: parson-gh-pat
